@page "/refbook/products/{GroupId:int?}"
@using PorphumReferenceBook.Logic.Abstractions.Storage.Repository;
@using PorphumReferenceBook.Logic.Models.Product;

@inject IProductGroupRepository productGroupRepository;
@inject NavigationManager Navigation

<PageTitle>Наименования</PageTitle>
<br/>
<div class="row">
    <Button Class="col-md-1"
            Style="margin-right:1rem;"
            Type="ButtonType.Link"
            Color="ButtonColor.Dark"
            @onclick="@(()=>toggleItem.ToggleAsync())">
        @toggleItem.ButtonTittle
    </Button>
    <Button Class="col-md-1"
            Type="ButtonType.Link"
            Color="ButtonColor.Primary"
            @onclick="@(()=>Navigation.NavigateTo("refbook/product/create"))">
        Создать
    </Button>
</div>

<Collapse @ref=toggleItem.CollapseItem
          OnHiding="toggleItem.OnHiddenCallback"
          OnShown="toggleItem.OnShownCallback">
    <div class="row">
        <EditForm EditContext="_editContext">
            <p>
                Название:<br />
                <InputText id="search-string" @bind-Value="_filter.SearchString" />
            </p>
            <p>
                Группа: <br />
                <InputSelect @bind-Value="_filter.GroupId" id="search-group">
                    <option value="0">None</option>
                    @if (_groups.Any())
                    {
                        @foreach (var group in _groups)
                        {
                            <option value="@group.Key">@group.Name</option>
                        }
                    }
                </InputSelect>
            </p>
        </EditForm>
    </div>
</Collapse>
<hr />

<br />

<ProductsTable NameLike=@_filter.SearchString GroupsKeys="@_filter.Groups" />


@code {
    private ToggleClass toggleItem = new();

    private FilterClass _filter = new();
    private EditContext? _editContext;

    private IEnumerable<ProductGroup> _groups = Enumerable.Empty<ProductGroup>();

    [Parameter]
    public int? GroupId { get; set; }

    protected override void OnInitialized()
    {
        _filter.GroupId = GroupId;
        _groups = productGroupRepository.GetEntities();

        _editContext = new(_filter);
    }

    public class FilterClass
    {
        public string? SearchString { get; set; } = null!;

        public int? GroupId { get; set; } = null!;

        public List<int>? Groups => GroupId is null || GroupId == 0 
            ? null
            : new List<int>()
                .Append(GroupId.Value)
                .ToList();
    }


    public class ToggleClass
    {
        private static string SHOW_BUTTON_TITTLE = "Поиск";
        private static string HIDE_BUTTON_TITTLE = "Скрыть";

        public Collapse CollapseItem { get; set; } = default!;
        public string ButtonTittle { get; set; } = SHOW_BUTTON_TITTLE;

        public async Task ToggleAsync()
        {
            await CollapseItem.ToggleAsync();
        }

        public void OnHiddenCallback()
        {
            ButtonTittle = SHOW_BUTTON_TITTLE;
        }

        public void OnShownCallback()
        {
            ButtonTittle = HIDE_BUTTON_TITTLE;
        }
    }
}
