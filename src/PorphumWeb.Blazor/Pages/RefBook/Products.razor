@page "/refbook/products/{GroupId:int?}"
@using PorphumReferenceBook.Logic.Abstractions.Storage.Repository;
@using PorphumReferenceBook.Logic.Models.Product;
@using PorphumWeb.Blazor.Classes

@inject IProductGroupRepository productGroupRepository;
@inject NavigationManager Navigation

<PageTitle>Наименования</PageTitle>
<br/>
<div class="row">
    <Button Class="col-md-1"
            Style="margin-right:1rem;"
            Type="ButtonType.Link"
            Color="ButtonColor.Dark"
            @onclick="@(()=>toggleItem.ToggleAsync())">
        @toggleItem.ButtonTittle
    </Button>
    <Button Class="col-md-1"
            Type="ButtonType.Link"
            Color="ButtonColor.Primary"
            @onclick="@(()=>Navigation.NavigateTo("refbook/product/create"))">
        Создать
    </Button>
</div>

<Collapse @ref=toggleItem.CollapseItem
          OnHiding="toggleItem.OnHiddenCallback"
          OnShown="toggleItem.OnShownCallback">
    <br />
        <EditForm EditContext="_editContext">
            <div class="row">
                <div class="@FilterClass.TITTLE_CLASS">
                    Название:
                </div>
                <div class="@FilterClass.VALUE_CLASS">
                    <InputText id="search-string" @bind-Value="_filter.SearchString" />
                </div>
            </div>
        <br />
            <div class="row">
                <div class="@FilterClass.TITTLE_CLASS">
                    Группа:
                </div>
                <div class="@FilterClass.VALUE_CLASS">
                    <InputSelect @bind-Value="_filter.GroupId" id="search-group">
                        <option value="0">None</option>
                        @if (_groups.Any())
                        {
                            @foreach (var group in _groups)
                            {
                                <option value="@group.Key">@group.Name</option>
                            }
                        }
                    </InputSelect>
                </div>                
            </div>
        </EditForm>
</Collapse>
<hr />

<br />

<ProductsTable NameLike=@_filter.SearchString GroupsKeys="@_filter.Groups" />


@code {
    private ToggleClass toggleItem = new();

    private FilterClass _filter = new();
    private EditContext? _editContext;

    private IEnumerable<ProductGroup> _groups = Enumerable.Empty<ProductGroup>();

    [Parameter]
    public int? GroupId { get; set; }

    protected override void OnInitialized()
    {
        _filter.GroupId = GroupId;
        _groups = productGroupRepository.GetEntities();

        _editContext = new(_filter);
    }

    public class FilterClass
    {
        public static string TITTLE_CLASS = "col-1 col-md-1";
        public static string VALUE_CLASS = "col-5 col-md-5";

        public string? SearchString { get; set; } = null!;

        public int? GroupId { get; set; } = null!;

        public List<int>? Groups => GroupId is null || GroupId == 0 
            ? null
            : new List<int>()
                .Append(GroupId.Value)
                .ToList();
    }
}
